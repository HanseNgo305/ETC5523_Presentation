---
title: "work_note"
author: "Hanh Ngo"
date: "10/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(lubridate)
library(naniar)
library(leaflet)
library(ggplot2)
```

# Hello


# What we talk about

(In this presentation, we will try to answer the question)
Is there evidence to suggest that the air quality in Melbourne decreased during the summer bushfire season?
How does air quality compare now?

(subtitle)
Using the date obtained from 5 climate sensors in Melbourne City Council


# The data
## Quick look

## Explaination of used var

Air quality is measured in.... (source to EPA)
In this dataset, we will be utilizing only 2 variables:.... These two are erroneous, but with low quantity

We want to look by month and maybe Day (if needed). 


# First skim (not bring to slide)

```{r read-data}
sensor_location <- read.csv(here::here("data", "Microclimate_Sensor_Locations.csv"))
sensor_reading <- read.csv(here::here("data", "Microclimate_Sensor_Readings.csv"))
fire_archive <- read.csv(here::here("data", "fire_archive_V1_101674.csv")) %>%
  select(latitude, longitude, acq_date, frp)
fire_nrt <- read.csv(here::here("data", "fire_nrt_V1_101674.csv")) %>%
  select(latitude, longitude, acq_date, frp)
```

```{r clean-up}
# Check structure, notice some factor typeå
str(sensor_reading)

sensor_reading <- sensor_reading %>%
  # Change from factor to date time
  mutate(local_time = ymd_hms(local_time, tz = "UTC"),
  # Change some factors to character type
         type = as.character(type),
         units = as.character(units))

# Merge with sensor location
sensor_reading_location <- sensor_reading %>%
  left_join(sensor_location, by = "site_id")

# fire location merged
fire_location <- rbind(fire_archive, fire_nrt)
# reformat and choose days that matched with sensor data
fire_location <- fire_location %>%
  mutate(acq_date = ymd(acq_date)) %>%
  filter(acq_date > "2019-11-14")
```

```{r missing-check}
vis_miss(sensor_reading_location, warn_large_data = FALSE)
```

```{r}
# Check the errorneous in reading
sensor_reading_location %>%
  filter(sensor_id %in% c("0a.EPA-1h.PKIND", "0b.EPA-1h.PKIND")) %>%
  group_by(sensor_id) %>%
  count(value)
```

```{r}
# check only the type of sensor used
check_sensor <- c("0a.EPA-24h","0b.EPA-24h")

# 15/11 has 15 timeslots (starting from 9:00 to 23:00), other has 24 timeslots except for the last day having only 5
sensor_reading_location %>%
  filter(sensor_id %in% check_sensor) %>%
  mutate(time = strftime(local_time, format="%H:%M:%S", tz = "UTC"),
         day = day(local_time),
         month = month(local_time, abbr = TRUE),
         year = year(local_time)) %>%
  group_by(year, month, day, site_id) %>%
  count(day)
```

The number of error reading is small --> acceptable. We choose 1h and 24h to refer from the EPA guideline of safety and national standard.

```{r}
# Choose the selected sensor_id
select_sensor <- c("0a.EPA-1h", "0a.EPA-24h", "0b.EPA-1h", "0b.EPA-24h")

sensor_reading_location <- sensor_reading_location %>%
  filter(sensor_id %in% select_sensor) %>%
  #select(-last_data,-location, -units, -description) %>%
  mutate(time = strftime(local_time, format="%H:%M:%S", tz = "UTC"),
         day = day(local_time),
         month = month(local_time, abbr = TRUE),
         year = year(local_time)) %>%
  group_by(site_id, year, month) %>%
  arrange(local_time)
```

```{r}
ggmap::qmplot(longitude, latitude, data = sensor_location, colour = I('red'))
```

# Daily reading of PM2.5 and PM10

Since pm2.5 is more dangerous, we will look at this first

```{r daily-avg}
# Daily pm2.5 24 hour average = pm2.5 at the latest of a day. 
daily_pm_2.5 <- sensor_reading_location %>%
  filter(sensor_id == "0a.EPA-24h") %>%
  #mutate(air_quality_2.5 = case_when(
  #  value < 8 ~ "Good",
  #  value >=8 & value < 25 ~ "Moderate",
  #  value >=25 & value < 40 ~ "Poor",
  #  value >=40 & value < 177 ~ "Very Poor",
  #  TRUE ~ "Hazardous")) %>%
  filter(time == max(time))
```

```{r check-daily-pm-2.5}
daily_pm_2.5 %>%
  group_by(year, month, day) %>%
  count(site_id)
```

## plotting

```{r daily-pm2.5-plot}
# obtain daily average regardless of site_id
daily_avg_pm_2.5 <- daily_pm_2.5 %>%
  group_by(local_time) %>%
  summarise_at(vars(value), funs(mean(., na.rm=TRUE))) %>%
  mutate(air_quality_2.5 = case_when(
    value < 8 ~ "Good",
    value >=8 & value < 25 ~ "Moderate",
    value >=25 & value < 40 ~ "Poor",
    value >=40 & value < 177 ~ "Very Poor",
    TRUE ~ "Hazardous"))

# create colour palette
quality_colour <- tibble(
  air_quality_2.5 = c("Good", "Moderate", "Poor", "Very Poor", "Hazardous"),
  Color = c("green", "yellow", "orange", "red", "brown"))

# assign colour to each quality
daily_avg_pm_2.5$air_quality_2.5 <- factor(daily_avg_pm_2.5$air_quality_2.5, levels = quality_colour$air_quality_2.5)

# plot
daily_avg_pm_2.5 %>%
  ggplot(aes(x = local_time, y = value, fill = air_quality_2.5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = quality_colour$Color) +
  # facet_wrap(~site_id) +
  theme_minimal() +
  scale_x_datetime(date_breaks = "1 month", date_labels = "%b-%Y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ggtitle("Daily air quality identified by PM2.5") +
  xlab("Day")

## Total days of observation is max(sensor_reading_location$local_time) - min(sensor_reading_location$local_time)
## However this only has 344 rows, lacking the observation on 24th January 2020
```

## count the number of good day and bad day
```{r AQ-count-2.5}
day_count_2.5 <- daily_avg_pm_2.5 %>%
  mutate(day = day(local_time),
         month = month(local_time, abbr = TRUE),
         year = year(local_time)) %>%
  group_by(year, month) %>%
  count(air_quality_2.5)
```

```{r day-count-2.5}
day_count_2.5 %>%
  ggplot(aes(x =))
```


# Monthly reading of pm2.5

```{r monthly-avg}
# Monthly pm2.5 = average of daily pm2.5
monthly_pm_2.5 <- daily_avg_pm_2.5 %>%
  mutate(
         month = month(local_time, abbr = TRUE),
         year = year(local_time)) %>%
  group_by(year, month) %>%
  summarise(value = mean(value)) %>%
  mutate(month_yr = paste0(month,"/",year)) %>%
  arrange(year,month)

monthly_pm_2.5
```

# Daily reading of pm10

```{r daily-avg-10}
# Daily pm10 24 hour average = pm10 at the latest of a day. 
daily_pm_10 <- sensor_reading_location %>%
  filter(sensor_id == "0b.EPA-24h") %>%
  mutate(air_quality = case_when(
    value < 50 ~ "Good",
    TRUE ~ "Warning")) %>%
  filter(time == max(time))

daily_pm_10 
```

```{r daily-pm10-plot}
# obtain daily average regardless of site_id
daily_avg_pm_10 <- daily_pm_10 %>%
  group_by(local_time) %>%
  summarise_at(vars(value), funs(mean(., na.rm=TRUE))) %>%
  mutate(air_quality_10 = case_when(
    value < 50 ~ "Good",
    TRUE ~ "Warning"))

# create colour palette
quality_colour_pm10 <- tibble(
  air_quality = c("Good", "Warning"),
  Color = c("green", "orange"))

# assign colour to each quality
daily_avg_pm_10$air_quality_10 <- factor(daily_avg_pm_10$air_quality_10, levels = quality_colour_pm10$air_quality)

# plot
daily_avg_pm_10 %>%
  ggplot(aes(x = local_time, y = value, fill = air_quality_10)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = quality_colour_pm10$Color) +
  theme_minimal() +
  scale_x_datetime(date_breaks = "1 month", date_labels = "%b-%Y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ggtitle("Daily air quality identified by PM10") +
  xlab("Day")
```

# monthly reading of PM10

```{r monthly-avg-10}
# Monthly pm10 = average of daily pm10
monthly_pm_10 <- daily_pm_10 %>% ungroup() %>%
  mutate(month_yr = strftime(local_time, format="%b-%y")) %>%
  group_by(year, month, month_yr) %>%
  summarise(value = mean(value))

monthly_pm_10 
```

# Put together with monthly bush fire occurence?

```{r count-location, eval = FALSE}
# Try to pick only fire occurred near Melbourne
geo <- fire_location %>%
  select(latitude, longitude) %>%
  arrange(desc(latitude)) %>%
  # roughly estimate
  filter(latitude < -37.7 & latitude > -38,
         longitude < 145.2 & longitude > 144.8) %>%
  mutate(location = paste0(latitude," - ",longitude))

distinct(geo, location, .keep_all = TRUE) # 17 disctinct location -> too little?
```

```{r fire-locate}
day_frp <- fire_location %>% 
  group_by(acq_date) %>%
  summarise_at(vars(frp), funs(sum(., na.rm=TRUE))) %>%
  arrange(acq_date)
```

```{r combined-plot}
# plot pm2.5
p1 <- daily_avg_pm_2.5 %>%
  filter(local_time < "2020-01-31") %>%
  ggplot(aes(x = local_time, y = value, fill = air_quality_2.5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = quality_colour$Color) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  guides(fill = guide_legend(reverse=TRUE)) +
  ggtitle("Daily air quality determined by PM2.5") +
  xlab("")

# plot pm10
p2 <- daily_avg_pm_10 %>%
  filter(local_time < "2020-01-31") %>%
  ggplot(aes(x = local_time, y = value, fill = air_quality_10)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = quality_colour_pm10$Color) +
  guides(fill = guide_legend(reverse=TRUE)) +
  theme_minimal() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  ggtitle("Daily air quality identified by PM10") +
  xlab("")

# plot frp
p3 <- day_frp %>%
  ggplot(aes(x = acq_date, y = frp, fill = "red")) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  scale_x_date(date_breaks = "5 day", date_labels = "%b-%d-%Y") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5),
        legend.position = "none") +
  ggtitle("Daily fire radiation power (frp)") +
  xlab("")

library(patchwork)
p1/p2/p3+plot_layout(guides = "collect")
```



# To clarify

1. When is the summer bush fire season?  May need to describe the season this time(how is the temperature, the wind frequence, the air pressure)

- Data is included for roughly a year only --> What possible limitation?

2. What defines air quality? What sort of changes associated with it

2.1 Definitions

- PM2.5: Fine particulate matter (PM2.5) is an air pollutant that is a concern for people's health when levels in air are high. PM2.5 are tiny particles in the air that reduce visibility and cause the air to appear hazy when levels are elevated. Outdoor PM2.5 levels are most likely to be elevated on days with little or no wind or air mixing.  
https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm   
- PM10: Small particles less than 10 micrometers in diameter pose the greatest problems, because they can get deep into your lungs, and some may even get into your bloodstream.  
https://www.epa.gov/pm-pollution/health-and-environmental-effects-particulate-matter-pm  
https://www.health.nsw.gov.au/environment/air/Pages/particulate-matter.aspx  
- Humidity: Humans are very sensitive to humidity, as the skin relies on the air to get rid of moisture. The process of sweating is your body's attempt to keep cool and maintain its current temperature. If the air is at 100 percent relative humidity, sweat will not evaporate into the air. As a result, we feel much hotter than the actual temperature when the relative humidity is high  
https://science.howstuffworks.com/nature/climate-weather/atmospheric/question651.htm  
- Barometric Pressure: https://www.treehugger.com/how-changes-barometric-pressure-affect-your-body-4868811  

2.2. Effects

**Winds Affect Air Quality**

Wind patterns have an impact on air quality because winds move air pollution around. For example, a coastal area with an inland mountain range may have more air pollution during the day when sea breezes push pollutants over land and lower air pollution in the evenings because the direction of the breeze reverses. Land breezes in the evenings push air pollution out over the ocean.

**Temperature Affects Air Quality**

Temperature can also affect air quality. In urban areas, air quality is often worse in the winter months. When the air temperature is cooler, exhaust pollutants can be trapped close to the surface beneath a layer of dense, cold air. In summer months, heated air rises and disperses pollutants from the Earth’s surface through the upper troposphere, and increased sunlight results in more harmful ground-level ozone.  
https://scied.ucar.edu/learning-zone/air-quality/what-is-air-quality

3. What to compare with the air quality in bush fire season - air quality in winter?

- Consider source for monitoring Air Quality index in Melbourne

3. How does air quality compare now - when is now? - Compare with October 2020.

# To think
1. What is the time stamp we want to use? By hour? by rolling average 24 hours? Barometric pressure is measured every 15 mins

Monthly

# Idea

- A coloured chrolopeth map that showed the degree of each measurement for each location --> try to find if location would correlate with the bush fires.  

# Slides Structure

## Introduction of the dataset, including the source

## Explaination for some of the variables

## Cleaning process (if needed to link with the analysis)

## Findings

## Conclusions
